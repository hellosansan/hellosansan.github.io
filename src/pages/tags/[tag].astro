---
import BaseHead from "../../components/BaseHead.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import HomePosts from "../../components/HomePosts.astro";

import { SITE_TITLE } from "../../config";

export async function getStaticPaths() {
  const postImports = import.meta.glob("../../posts/*.md");
  const allPosts = await Promise.all(Object.values(postImports).map((p) => p()));
  const allTags = new Set<string>();
  allPosts.forEach((post) => {
    post.frontmatter.tags?.forEach((tag: string) => allTags.add(tag));
  });

  return Array.from(allTags).map((tag) => ({
    params: { tag: tag },
    props: { originalTag: tag }
  }));
}

const { tag } = Astro.params;
const { originalTag } = Astro.props;

const postImports = import.meta.glob("../../posts/*.md");
const allPosts = await Promise.all(Object.values(postImports).map((p) => p()));
const filteredPosts = allPosts.filter((post) => !post.frontmatter.hidden && post.frontmatter.tags?.includes(originalTag));
---

<!doctype html>
<html lang="zh-cn">
  <BaseHead title={originalTag} pageType="tag" />

  <body>
    <Header title={`Tag: ${originalTag}`} />

    <main>
      <h2 style="margin-bottom: -0.5em;">
        含有标签 “{originalTag}” 的博客
      </h2>

      <HomePosts allPosts={filteredPosts} />
    </main>

    <Footer />
  </body>
</html>
